@model List<Survey.Models.BigModel>

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    int k = 0;
}

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <!--begin::Card-->
            <div class="card card-custom gutter-b example example-compact">
                <div class="card-header">
                    <h3 class="card-title">Create new online survey</h3>
                </div>
                <!--begin::Form-->
                <form>
                    <div class="card-body">
                        <div class="form-group">
                            <label>
                                Name
                                <span class="text-danger">*</span>
                            </label>
                            <input id="survey-name" type="text" class="form-control" placeholder="Enter survey name">
                        </div>

                        <div class="form-group mb-1">
                            <label for="exampleTextarea">
                                Description
                                <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="survey-description" rows="3"></textarea>
                        </div>
                        <!--begin: Code-->

                    </div>
                </form>
                <!--end::Form-->
            </div>

        </div>

    </div>
    <div class="row" id="list-question">
        <div class="col-md-12">
            <!--begin::Card-->
            <div class="card card-custom gutter-b example example-compact">
                <div class="card-header">
                    <h3 class="card-title">Question 1</h3>
                </div>
                <!--begin::Form-->
                <form>
                    <div class="card-body">
                        <div class="form-group">
                            <label>
                                Title
                                <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control title-question" placeholder="Enter question name">
                        </div>
                        <div class="form-group">
                            <label for="exampleSelect1">
                                Question type
                                <span class="text-danger">*</span>
                            </label>
                            <select class="form-control type-question">
                                <option value="">---Please choose type of question---</option>
                                <option value="1">Yes no question</option>
                                <option value="2">Check true</option>
                            </select>
                        </div>
                        <div class="form-group mb-1">
                            <label for="exampleTextarea">
                                Description
                                <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control des-question" rows="3"></textarea>
                        </div>
                        <!--begin: Code-->
                        <div class="form-group mb-1">

                            <div class="mt-2 text-right">
                                <a href="#" class="mr-3 add-more-answer">Add answer</a>
                            </div>
                        </div>
                    </div>

                </form>
                <!--end::Form-->
            </div>
        </div>

    </div>
    <div class="row">
        <div class="col-md-12 text-right">
            <a href="" class="mr-5" id="add-more-question">Add more question</a>
        </div>
    </div>
    <div class="row mt-5">
        <div class="col-md-12 text-right">
            <button type="reset" class="btn btn-primary mr-2 " id="btnSave">Submit</button>
            <button type="reset" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

@section Scripts{
    @Scripts.Render("~/bundles/jqueryval")
    <script language="javascript">
        document.addEventListener("DOMContentLoaded", function () {
            var count = 1;
            $("#add-more-question").click(function (e) {
                e.preventDefault();
                count++;
                $("#list-question").append(`
                                <div class="col-md-12">
                                    <!--begin::Card-->
                                    <div class="card card-custom gutter-b example example-compact">
                                        <div class="card-header">
                                            <h3 class="card-title">Question ${count}</h3>
                                        </div>
                                        <!--begin::Form-->
                                        <form>
                                            <div class="card-body">
                                                <div class="form-group">
                                                    <label>
                                                        Title
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <input type="text" class="form-control title-question" placeholder="Enter question name">
                                                </div>
                                                <div class="form-group">
                                                    <label for="exampleSelect1">
                                                        Question type
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <select class="form-control type-question" >
                                        <option value="">---Please choose type of question---</option>
                                        <option value="1">Yes no question</option>
                                        <option value="2">Check true</option>
                                    </select>
                                </div>
                                <div class="form-group mb-1">
                                    <label for="exampleTextarea">
                                        Description
                                        <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control des-question" rows="3"></textarea>
                                                </div>
                                                <!--begin: Code-->
                                                <div class="form-group mb-1">
                                                    <div class="mt-2 text-right">
                                                        <a href="#" class="mr-3 add-more-answer">Add answer</a>
                                                    </div>
                                                </div>
                                            </div>

                                        </form>
                                        <!--end::Form-->
                                    </div>
                                </div>
                            `);
                $("html, body").animate({ scrollTop: $(document).height() }, "slow");
            });

            $("body").on("click", ".add-more-answer", function (e) {
                e.preventDefault();
                var nearestFormGroup = $(this).parent().parent();
                var tableAnswerLength = nearestFormGroup.find("table tbody").length;
                if (tableAnswerLength == 0) {
                    nearestFormGroup.prepend(`
                                    <table class="table answer-table">
                                        <thead>
                                            <tr>
                                                <th class="w-25" scope="col">Number</th>
                                                <th scope="col">Answer Content</th>
                                                <th scope="col">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                `);
                }
                var tableBody = nearestFormGroup.find("table tbody");
                tableBody.append(`
                                 <tr>
                                    <th scope="row"></th>
                                    <td>
                                        <input type="text" class="form-control w-75"/>
                                    </td>
                                    <td>
                                        <a href="#" class="mr-3 save-answer">Save</a>
                                        <a href="#" class="remove-answer">Delete</a>
                                    </td>
                                </tr>
                            `);
            });
            // function click delete answe
            $("body").on("click", ".remove-answer", function (e) {
                e.preventDefault();
                $(this).parent().parent().remove();
                // dem lai so luong cau hoi, update stt.

            });

            // function click save answer
            $("body").on("click", ".save-answer", function (e) {
                e.preventDefault();
                var tr = $(this).parent().parent();
                var countTr = tr.parent().find("tr").length; // tinh so tr cua table gan nhat
                var inputVal = tr.find("input").val();
                tr.html(`
                                    <th scope="row">${countTr}</th>
                                    <td class ="answer-content">
                                        ${inputVal}
                                    </td>
                                    <td>
                                        <a href="#" class="mr-3 save-answer">Save</a>
                                        <a href="#" class="remove-answer">Delete</a>
                                    </td>
                            `);
            });


            //function click submit
            $("body").on("click", "#btnSave", function () {
                //Loop through the Table rows and build a JSON array.
                $scanQuestion = $("#list-question").find(".card-body");
                $scanQuestionTitle = $scanQuestion.parent().parent().find(".title-question").length;
                $scanAnswers = $scanQuestion.parent().parent().find(".answer-content").length;


                var allSurveys = new Array();
                var questions = new Array();
                var answers = new Array();

                var allSurvey = {};
                allSurvey.Title = $("#survey-name").val();
                allSurvey.Description = $("#survey-description").val();
                allSurveys.push(allSurvey);


                for (var i = 0; i < $scanQuestionTitle; i++) {
                    var question = {};
                    question.Title = $scanQuestion.parent().parent().find(".title-question").eq(i).val();
                    question.Type = $scanQuestion.parent().parent().find(".type-question").eq(i).val();
                    question.Description = $scanQuestion.parent().parent().find(".des-question").eq(i).val();
                    question.Answer = answers;
                    questions.push(question);

                }
                for (var j = 0; j < $scanAnswers; j++) {
                    var answer = {};
                    answer.Answer = $scanQuestion.parent().parent().find(".answer-content").eq(j).text();
                    answers.push(answer);
                }


                var bigModels = {
                    "AllSurvey": allSurveys,
                    "Question": questions,
                };

                console.log(bigModels);
                $.ajax({
                    type: "POST",
                    url: "/QuestionAnswers/Create",
                    data: JSON.stringify(bigModels),
                    //data: JSON.stringify(questions),
                    contentType: "application/json; charset=utf-8",
                    success: function () {
                        location.reload();
                    },
                    error: function () {
                        alert(1);

                    }
                });



                //$("#list-question").each(function () {

                //    for (var i = 0; i < 3; i++) {
                //        var answer = {};
                //        answer.Title = "Đáp án " + i,
                //            answers.push(answer);
                //    }
                //});






            });
        });
    </script>

}
